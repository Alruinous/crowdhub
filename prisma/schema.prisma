// Prisma 客户端生成器配置
generator client {
  provider = "prisma-client-js"  // 生成 TypeScript/JavaScript 客户端
}

// 数据库连接配置
datasource db {
  provider = "sqlite"            // 使用 SQLite 数据库
  // 改为从环境变量读取，便于切换到 Postgres/MySQL 等
  url = env("DATABASE_URL")
  // url = "file:./dev.db"
}

// 用户模型 - 系统用户信息
model User {
  id            String         @id @default(cuid())          // 用户唯一标识
  name          String                                       // 用户姓名
  email         String         @unique                       // 邮箱（唯一）
  password      String                                       // 加密后的密码
  role          Role           @default(WORKER)              // 用户角色
  points        Int            @default(0)                   // 积分余额
  banned        Boolean        @default(false)               // 是否被封禁
  createdAt     DateTime       @default(now())               // 创建时间
  updatedAt     DateTime       @updatedAt                    // 最后更新时间
  
  // 关联关系
  publishedTasks Task[]        @relation("PublishedTasks")   // 发布的任务
  claimedTasks  Subtask[]      @relation("ClaimedTasks")     // 认领的子任务
  messages      Message[]                                    // 发送的消息
  categories    UserCategory[]                               // 用户关注的分类

  //数据标注
  publishedAnnotationTasks AnnotationTask[]              @relation("PublishedAnnotationTasks")
  claimedAnnotationTasks   AnnotationTask[]              @relation("ClaimedAnnotationTasks")
  annotationResults        AnnotationResult[]            @relation("AnnotationResults")
  taskAbilities            UserAnnotationTaskAbility[]   @relation("UserAbilities")
  // annotationMessages      AnnotationMessage[]
}

// 分类模型 - 科普任务分类
model Category {
  id        String         @id @default(cuid())      // 分类唯一标识
  name      String         @unique                   // 分类名称（唯一）
  createdAt DateTime       @default(now())           // 创建时间
  updatedAt DateTime       @updatedAt                // 最后更新时间
  
  // 关联关系
  tasks     Task[]                                  // 属于该分类的任务
  users     UserCategory[]                          // 关注该分类的用户
  // annotationTasks AnnotationTask[]                  // 属于该分类的标注任务
}

// 任务类型模型 - 科普任务类型
model TaskType {
  id        String   @id @default(cuid())    // 类型唯一标识
  name      String   @unique                 // 类型名称（唯一）
  createdAt DateTime @default(now())         // 创建时间
  updatedAt DateTime @updatedAt              // 最后更新时间
  
  // 关联关系
  tasks     Task[]                          // 属于该类型的任务
}

// 主任务模型 - 科普主任务信息
model Task {
  id          String    @id @default(cuid())        // 任务唯一标识
  title       String                                // 任务标题
  description String                                // 任务描述
  status      TaskStatus @default(OPEN)             // 任务状态
  points      Int                                   // 任务总积分
  maxWorkers  Int                                   // 最大接单者数量
  approved    Boolean   @default(false)             // 是否已审批通过
  createdAt   DateTime  @default(now())             // 创建时间
  updatedAt   DateTime  @updatedAt                  // 最后更新时间
  completedAt DateTime?                             // 完成时间（可选）
  
  // 关联关系
  publisher   User      @relation("PublishedTasks", fields: [publisherId], references: [id], onDelete: Cascade)
  publisherId String                                // 发布者ID
  category    Category @relation(fields: [categoryId], references: [id])
  categoryId  String                                // 分类ID
  type        TaskType @relation(fields: [typeId], references: [id])
  typeId      String                                // 任务类型ID
  subtasks    Subtask[]                             // 子任务列表
  messages    Message[]                             // 任务相关消息
}

// 子任务模型 - 主任务分解后的子任务
model Subtask {
  id          String        @id @default(cuid())    // 子任务唯一标识
  title       String                                // 子任务标题
  description String                                // 子任务描述
  points      Int                                   // 子任务积分
  status      SubtaskStatus @default(OPEN)          // 子任务状态
  createdAt   DateTime      @default(now())         // 创建时间
  updatedAt   DateTime      @updatedAt              // 最后更新时间
  completedAt DateTime?                             // 完成时间（可选）
  
  // 关联关系
  task        Task          @relation(fields: [taskId], references: [id], onDelete: Cascade)
  taskId      String                                // 所属主任务ID
  worker      User?         @relation("ClaimedTasks", fields: [workerId], references: [id])
  workerId    String?                               // 认领接单者ID（可选）
}

// 消息模型 - 任务聊天消息
model Message {
  id        String   @id @default(cuid())    // 消息唯一标识
  content   String                           // 消息内容
  createdAt DateTime @default(now())         // 发送时间
  
  // 关联关系
  sender    User     @relation(fields: [senderId], references: [id], onDelete: Cascade)
  senderId  String                           // 发送者ID
  task      Task     @relation(fields: [taskId], references: [id], onDelete: Cascade)
  taskId    String                           // 所属任务ID
}

// 用户-分类关联模型 - 多对多关系中间表
model UserCategory {
  id         String   @id @default(cuid())    // 关联记录唯一标识
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId     String                           // 用户ID
  category   Category @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  categoryId String                           // 分类ID
  createdAt  DateTime @default(now())         // 创建时间

  @@unique([userId, categoryId]) // 确保每个用户-类别组合只存在一次（防止重复关注）
}

// AI配置模型 - 系统AI服务配置
model AiConfig {
  id        String   @id @default(cuid())    // 配置唯一标识
  key       String   @unique                 // 配置键（唯一）
  value     String                           // 配置值
  label     String                           // 配置标签（显示名称）
  createdAt DateTime @default(now())         // 创建时间
  updatedAt DateTime @updatedAt              // 最后更新时间
}

// 用户角色枚举
enum Role {
  ADMIN      // 管理员 - 系统管理权限
  PUBLISHER  // 发布者 - 发布和管理任务
  WORKER     // 接单者 - 认领和完成任务
}

// 主任务状态枚举
enum TaskStatus {
  OPEN         // 开放中 - 可认领
  IN_PROGRESS  // 进行中 - 已有接单者认领
  COMPLETED    // 已完成 - 所有子任务完成
}

// 子任务状态枚举
enum SubtaskStatus {
  OPEN             // 开放中 - 可认领
  IN_PROGRESS      // 进行中 - 已被认领，正在完成
  PENDING_APPROVAL // 待审批 - 已完成，等待发布者审批
  COMPLETED        // 已完成 - 已通过审批
}


// 数据标注任务状态枚举
enum AnnotationTaskStatus {
  OPEN             // 开放中 - 可认领
  IN_PROGRESS      // 进行中 - 开始进行，不能再认领
  COMPLETED        // 已完成 - 所有数据标注完成
}


// 数据标注任务模型
model AnnotationTask {
  id          String                @id @default(cuid())
  title       String                                      // 任务标题
  description String?                                     // 任务描述
  status      AnnotationTaskStatus  @default(OPEN)       // 任务状态
  points      Int                   @default(0)           // 总积分
  maxWorkers  Int                   @default(1)           // 最大接单者数量
  approved    Boolean               @default(false)       // 是否已审批通过
  publishCycle Int?                 @default(1)           // 数据发布周期（天）
  publishLimit Int?                 @default(100)         // 每次每人数据发布上限（条）
  lastProcessedAt DateTime?                               // 上次处理时间（用于周期性任务）
  createdAt   DateTime              @default(now())
  updatedAt   DateTime              @updatedAt
  completedAt DateTime?                                   // 完成时间
  
  // 关联关系
  publisher   User                  @relation("PublishedAnnotationTasks", fields: [publisherId], references: [id], onDelete: Cascade)
  publisherId String
  workers     User[]                @relation("ClaimedAnnotationTasks")  // 认领该任务的用户
  dataFile    DataFile?             @relation(fields: [dataFileId], references: [id])
  dataFileId  String?               @unique
  labelFile   LabelFile?            @relation(fields: [labelFileId], references: [id])
  labelFileId String?               @unique
  annotations Annotation[]                                // 数据条目
  userAbilities UserAnnotationTaskAbility[]               @relation("TaskAbilities")
  
  @@map("annotation_tasks")
}


// 标注结果模型
model Annotation {
  id          String   @id @default(cuid())
  rowIndex    Int                                      // 数据行索引
  rowData     Json                                     // 数据内容
  status      AnnotationStatus   @default(PENDING)            // 标注状态
  taskId    String
  task      AnnotationTask @relation(fields: [taskId], references: [id], onDelete: Cascade)
  
  // 标注要求
  isfinished        Boolean @default(false)  // 是否标注完成
  requiredCount Int @default(3)  // 需要几人标注
  completedCount      Int @default(0)  // 已完成数
  publishedCount      Int @default(0)  // 已发布数(可能发放下去但是有人还没完成)

  // 能力需求向量（与UserTaskAbility的abilityVector对应）
  requirementVector Json?      // {"天文地理": x, "历史": y, ...}，数据对各标签的能力需求
  vectorLength      Int?       // 向量长度（应与任务标签数量一致）

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // 关联：一条数据有多个人的标注结果
  results   AnnotationResult[]
  
  @@map("annotations")
  @@unique([taskId, rowIndex])
  @@index([taskId, status])
}

// 数据标注任务状态枚举
enum AnnotationStatus {
  PENDING          // 待定
  COMPLETED        // 已完成
}

// 存储每个用户对某条数据的标注结果
model AnnotationResult {
  id          String   @id @default(cuid())
  
  annotationId  String
  annotation    Annotation @relation(fields: [annotationId], references: [id], onDelete: Cascade)
  
  annotatorId String
  annotator   User @relation("AnnotationResults", fields: [annotatorId], references: [id])
  
  isCorrect   Boolean?  // true，false，null（还未完成标注）
  isFinished  Boolean  @default(false)  // 是否标注完成
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  completedAt DateTime?
  
  // 关联：一个结果有多个选择（多维度）
  selections  AnnotationSelection[]
  
  @@unique([annotationId, annotatorId])  // 每人每条数据只能标注一次
  @@index([annotatorId, isCorrect])      // 支持按用户查询正确率
}


// 标注选择模型：按维度存储分类路径
model AnnotationSelection {
  id            String     @id @default(cuid())
  pathIds       Json                         // string[]，每级分类的ID
  pathNames     Json?                        // string[]，可选：每级分类的名称，便于导出
  dimensionName String     @default("默认分类") // 维度名称
  dimensionIndex Int       @default(0)       // 维度索引，用于排序
  createdAt     DateTime   @default(now())
  updatedAt     DateTime   @updatedAt

  // 关联
  resultId      String   // 改为关联到 AnnotationResult
  result        AnnotationResult @relation(fields: [resultId], references: [id], onDelete: Cascade)

  @@map("annotation_selections")
}

// 用户-标注任务能力向量模型
model UserAnnotationTaskAbility {
  id            String   @id @default(cuid())
  
  // 能力向量（最终计算结果）
  abilityVector Json     // [a_i1, a_i2, ..., a_iN]，每个元素 ∈ [0,1]
  vectorLength  Int      // 向量长度 N（标签总数）
  
  // 贝叶斯统计数据（JSON数组，与abilityVector对应）
  correctCounts Json     // [correct_i1, correct_i2, ..., correct_iN]，每个标签的正确次数
  totalCounts   Json     // [total_i1, total_i2, ..., total_iN]，每个标签的标注总次数
  alphaValues   Json     // [α_i1, α_i2, ..., α_iN]，Beta分布的α参数（擅长领域=2，其他=1）

  // 预计算的统计信息（加速查询）
  avgScore      Float    @default(0.5)    // 平均能力值
  minScore      Float    @default(0.5)    // 最低能力值
  maxScore      Float    @default(0.5)    // 最高能力值
  totalAnnotations Int   @default(0)      // 总标注次数（所有标签的sum）
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  // 关联关系
  user          User           @relation("UserAbilities", fields: [userId], references: [id], onDelete: Cascade)
  userId        String
  task          AnnotationTask @relation("TaskAbilities", fields: [taskId], references: [id], onDelete: Cascade)
  taskId        String
  
  @@unique([userId, taskId])
  @@index([taskId, avgScore])
  @@map("user_annotation_task_abilities")
}


// 数据文件模型
model DataFile {
  id          String           @id @default(cuid())
  filename    String                                         // 文件名
  originalName String                                         // 原始文件名
  path        String                                         // 文件存储路径
  size        Int                                            // 文件大小
  mimeType    String                                         // MIME类型
  rowCount    Int                                            // 数据行数
  columns     Json                                           // 列定义 (JSON数组)
  data        Json?                                          // 数据内容 (Any[])
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt
  
  // 关联关系
  annotationTask AnnotationTask?                             // 所属标注任务
  
  @@map("data_files")
}

// 标签文件模型
model LabelFile {
  id          String           @id @default(cuid())
  filename    String                                         // 文件名
  originalName String                                         // 原始文件名
  path        String                                         // 文件存储路径
  size        Int                                            // 文件大小
  data        Json?                                          // 数据内容 (JSON数组)
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt
  
  // 关联关系
  annotationTask AnnotationTask?                             // 所属标注任务
  
  @@map("label_files")
}

// 数据标注子任务模型
// model AnnotationSubtask {
//   id          String                   @id @default(cuid())
//   title       String                                         // 子任务标题
//   description String?                                        // 子任务描述
//   points      Int                      @default(0)           // 子任务积分
//   status      AnnotationSubtaskStatus  @default(OPEN)        // 子任务状态
//   startRow    Int                                            // 起始行号
//   endRow      Int                                            // 结束行号
//   rowCount    Int                                            // 行数
//   createdAt   DateTime                 @default(now())
//   updatedAt   DateTime                 @updatedAt
//   completedAt DateTime?                                      // 完成时间
  
//   // 关联关系
//   task        AnnotationTask           @relation(fields: [taskId], references: [id], onDelete: Cascade)
//   taskId      String
//   worker      User?                    @relation("ClaimedAnnotationSubtasks", fields: [workerId], references: [id])
//   workerId    String?
//   annotations Annotation[]                                    // 标注结果
  
//   @@map("annotation_subtasks")
// }

// 标注任务消息模型
// model AnnotationMessage {
//   id        String   @id @default(cuid())    // 消息唯一标识
//   content   String                           // 消息内容
//   createdAt DateTime @default(now())         // 发送时间
  
//   // 关联关系
//   sender    User          @relation(fields: [senderId], references: [id], onDelete: Cascade)
//   senderId  String                           // 发送者ID
//   // task      AnnotationTask @relation(fields: [taskId], references: [id], onDelete: Cascade)
//   // taskId    String                           // 所属标注任务ID
  
//   @@map("annotation_messages")
// }



